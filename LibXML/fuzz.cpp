// Copyright 2015 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

//OSSFUZZ original code adapted to work with AFL++

#include <cassert>
#include <cstddef>
#include <cstdint>

#include <functional>
#include <limits>
#include <string>

#include "libxml/parser.h"
#include "libxml/xmlsave.h"

void ignore (void* ctx, const char* msg, ...) {
  // Error handler to avoid spam of error messages from libxml parser.
}

int LLVMFuzzerTestOneInput(const uint8_t* data, size_t size) {
  xmlSetGenericErrorFunc(NULL, &ignore);

  // Test default empty options value and some random combination.
  std::string data_string(reinterpret_cast<const char*>(data), size);
  const std::size_t data_hash = std::hash<std::string>()(data_string);
  const int max_option_value = std::numeric_limits<int>::max();
  const int random_option_value = data_hash % max_option_value;
  const int options[] = {0, random_option_value};

  for (const auto option_value : options) {
    if (auto doc = xmlReadMemory(data_string.c_str(), data_string.length(),
                                 "noname.xml", NULL, option_value)) {
      auto buf = xmlBufferCreate();
      assert(buf);
      auto ctxt = xmlSaveToBuffer(buf, NULL, 0);
      xmlSaveDoc(ctxt, doc);
      xmlSaveClose(ctxt);
      xmlFreeDoc(doc);
      xmlBufferFree(buf);
    }
  }

  return 0;
}

#include<stdio.h>
#include<fcntl.h>
#include<unistd.h>
#include<errno.h>
#include<cstdlib>
#include <sys/stat.h>

int main(int argc, char *argv[]){

	if(argc < 2){
		printf("Falta parametro\n");
		exit(-1);
	}

	struct stat st;
	stat(argv[1], &st);
	int size = st.st_size;
	unsigned char *buffer = (unsigned char *) calloc(size, sizeof(char));


	int fd = open(argv[1], O_RDONLY);
	int sz = read(fd, buffer, size);


	close(fd);

	LLVMFuzzerTestOneInput(buffer, size);

}
